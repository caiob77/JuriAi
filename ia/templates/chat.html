{% extends 'base.html' %}
{% load static %}

{% block 'head' %}
<title>Chat - {{ cliente.nome }}</title>
{% endblock 'head' %}

{% block 'body' %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Chat com IA Jur√≠dica</h1>
                    <p class="text-sm text-gray-600">Cliente: {{ cliente.nome }}</p>
                </div>
                <a href="{% url 'clientes' %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition">
                    Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Messages Area -->
            <div id="chat" class="h-[500px] overflow-y-auto p-6 space-y-4">
                <div class="flex items-start gap-2.5">
                    <img class="w-12 h-12 rounded-full" src="{% static 'assistente_virtual.png' %}" alt="JuriAI">
                    <div class="flex flex-col gap-1 w-full max-w-[320px]">
                        <div class="flex items-center space-x-2 rtl:space-x-reverse">
                            <span class="text-sm font-semibold text-gray-900">JuriAI</span>
                            <span class="text-sm font-normal text-gray-500">Agora</span>
                        </div>
                        <div class="flex flex-col leading-1.5 p-4 border-gray-200 bg-gray-200 rounded-e-xl rounded-es-xl">
                            <p class="text-sm font-normal py-2.5 text-gray-900">Ol√°! Sou seu assistente jur√≠dico virtual. Como posso ajud√°-lo hoje?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t bg-gray-50 p-4">
                <form id="form-pergunta" class="flex space-x-3">
                    <input 
                        type="text" 
                        id="pergunta" 
                        name="pergunta"
                        placeholder="Digite sua pergunta..." 
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        required
                    />
                    <button 
                        type="submit"
                        id="btn-enviar"
                        class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Enviar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Fun√ß√£o para obter hora atual formatada
    function getHoraAtual() {
        const agora = new Date();
        return agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    document.getElementById('form-pergunta').addEventListener('submit', async function(event){
        event.preventDefault();
        
        const pergunta = document.getElementById('pergunta').value;
        const formData = new FormData();
        formData.append('pergunta', pergunta);
        
        const response = await fetch("", {
            method: "POST",
            body: formData
        });
        
        const data = await response.json();
        const perguntaId = data.id;

        // Adicionar mensagem do usu√°rio
        const novaMensagem1 = document.createElement("div");
        novaMensagem1.className = "flex items-start gap-2.5 justify-end";
        novaMensagem1.innerHTML = `
            <div class="flex flex-col gap-1 w-full max-w-[320px] text-right">
                <div class="flex items-center justify-end space-x-2 rtl:space-x-reverse">
                    <span class="text-sm font-normal text-gray-500">${getHoraAtual()}</span>
                    <span class="text-sm font-semibold text-gray-900">Voc√™</span>
                </div>
                <div class="flex flex-col leading-1.5 p-4 bg-indigo-200 text-gray-900 rounded-s-xl rounded-ee-xl">
                    <p class="text-sm font-normal py-2.5">
                        ${pergunta}
                    </p>
                </div>
            </div>`;

        document.getElementById("chat").appendChild(novaMensagem1);
        
        // Limpar input
        document.getElementById('pergunta').value = '';
        
        // Adicionar mensagem da IA
        const novaMensagem = document.createElement("div");
        novaMensagem.className = "flex items-start gap-2.5";
       
        novaMensagem.innerHTML = `
            <img class="w-12 h-12 rounded-full" src="{% static 'assistente_virtual.png' %}" alt="JuriAI">
            <div class="flex flex-col gap-1 w-full max-w-[320px]">
                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                    <span class="text-sm font-semibold text-gray-900">JuriAI</span>
                    <span class="text-sm font-normal text-gray-500">${getHoraAtual()}</span>
                </div>
                <div class="flex flex-col leading-1.5 p-4 border-gray-200 bg-gray-200 rounded-e-xl rounded-es-xl">
                    <p id="resposta-juriai-${perguntaId}" class="text-sm font-normal py-2.5 text-gray-900"></p>
                </div>
                <a href="/ia/ver_referencias/${perguntaId}" class="text-sm font-normal text-indigo-600 hover:text-indigo-800 hover:underline">
                    üìö Confira as fontes
                </a>
            </div>
        `;

        document.getElementById("chat").appendChild(novaMensagem);
        
        // Scroll autom√°tico
        const chatContainer = document.getElementById("chat");
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Fazer streaming da resposta
        const streamResponse = await fetch("{% url 'stream_resposta' %}",{
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({id_pergunta: perguntaId})
        });
        
        const reader = streamResponse.body.getReader();
        const decoder = new TextDecoder("utf-8");
        const respostaElemento = document.getElementById(`resposta-juriai-${perguntaId}`);

        while (true){
            const {done, value} = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true});
            respostaElemento.innerText += chunk;
            
            // Auto-scroll durante o streaming
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });
</script>
{% endblock 'body' %}
